<?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
                "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

    <mapper namespace="bucheon.leafy.application.mapper.QnaMapper">

        <select id="countQna" resultType="int">
            SELECT count(*) FROM qna
        </select>


        <delete id="deleteAllQna">
            DELETE FROM qna
        </delete>

        <delete id="deleteQna" parameterType="map">
            DELETE FROM qna WHERE id = #{id} and user_user_id = #{user_user_id}
        </delete>

        <insert id="insertQna" parameterType="bucheon.leafy.domain.qna.domain.QnaDto">
            INSERT INTO qna
                (title, contents, id, qan_status)
            VALUES
                (#{title}, #{contents}, #{id}, #{qan_status})
        </insert>

        <select id="selectAllQna" resultType="bucheon.leafy.domain.qna.domain.QnaDto">
            SELECT id, created_at, modified_at, is_delete ,contents, qna_status, title, user_user_id
            FROM qna
            ORDER BY created_at DESC, id DESC
        </select>

        <sql id="selectFromQnA">
            SELECT id, created_at, modified_at, is_delete ,contents, qna_status, title, user_user_id
            FROM qna
        </sql>

        <select id="selectQna" parameterType="int" resultType="bucheon.leafy.domain.qna.domain.QnaDto">
            <include refid="selectFromQnA"/>
            WHERE id = #{id}
        </select>

        <select id="selectPageQna" parameterType="map" resultType="bucheon.leafy.domain.qna.domain.QnaDto">
            <include refid="selectFromQnA"/>
            ORDER BY created_at DESC, id DESC
            LIMIT #{offset}, #{pageSize}
        </select>

        <update id="updateQna" parameterType="bucheon.leafy.domain.qna.domain.QnaDto">
            UPDATE qna
            SET   title = #{title}
              , contents = #{contents}
              , modified_at = now()
            WHERE user_user_id = #{user_user_id}
        </update>

        <update id="updateCommentCntQna" parameterType="map">
            UPDATE qna
            SET   comment_cnt = comment_cnt + #{cnt}
            WHERE id = #{id}
        </update>

        <update id="increaseViewCntQna" parameterType="int">
            UPDATE qna
            SET   view_cnt = view_cnt + 1
            WHERE id = #{id}
        </update>
        <sql id="searchCondition">
            <choose>
                <when test='option=="T"'>
                    AND title LIKE concat('%', #{keyword}, '%')
                </when>
                <when test='option=="U"'>
                    AND user_user_id LIKE concat('%', #{keyword}, '%')
                </when>
                <otherwise>
                    AND (title   LIKE concat('%', #{keyword}, '%')
                    OR   contents LIKE concat('%', #{keyword}, '%'))
                </otherwise>
            </choose>
        </sql>

        <select id="searchSelectPageQna" parameterType="SearchCondition" resultType="bucheon.leafy.domain.qna.domain.QnaDto">
            SELECT id, created_at, modified_at, is_delete ,contents, qna_status, title, user_user_id
            FROM qna
            WHERE true
            <include refid="searchCondition"/>
            ORDER BY created_at DESC, id DESC
            LIMIT #{offset}, #{pateSize}
        </select>

        <select id="searchResultCntQna" parameterType="SearchCondition" resultType="int">
            SELECT count(*)
            FROM qna
            WHERE true
            <include refid="searchCondition"/>
        </select>
    </mapper>
