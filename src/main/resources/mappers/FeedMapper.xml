<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bucheon.leafy.application.mapper.FeedMapper">

    <select id="findFeedsToFollowers" resultType="FeedResponse" parameterType="java.lang.Long">
        select * from feed f
        <!--        join user u-->
        <!--        on f.user_id = u.user_id-->
        <!--        join feed_like_count flc -->
        <!--        on f.feed_id = flc.feed_id-->
        <!--        where is_delete = false-->
        <!--        order by created_at desc, f.created_at desc-->
        <!--        limit 10-->
    </select>

    <select id="findFeedsNotInFollowersFeeds" resultType="FeedResponse">
        select * from feed f
    </select>

    <select id="findFeedListFirst" resultType="FeedResponse" parameterType="ScrollRequest">
        select * from feed f
        join feed_like_count flc on f.feed_id = flc.feed_id
        where is_delete = false and feed_id &lt; #{key}
        order by created_at desc, f.created_at desc
        limit #{size}
    </select>

    <select id="findFeedList" resultType="FeedResponse" parameterType="ScrollRequest">
        select * from feed f
        join feed_like_count flc on f.feed_id = flc.feed_id
        where is_delete = false
        order by created_at desc, f.created_at desc
        limit #{size}
    </select>

    <select id="findFeedById" resultType="FeedResponse" parameterType="java.lang.Long" >
        select * from feed where feed_id = #{feedId} and is_delete = false
    </select>

    <insert id="saveFeed" parameterType="FeedRequest" useGeneratedKeys="true" keyColumn="feed_id" keyProperty="request.feedId">
        insert into feed (user_id,title,species,nickname,temperature,
                          humidity,water_amount,watering_period,
                          content,is_delete,feed_type,created_at,modified_at) values
                          (#{userId}, #{request.title}, #{request.species}, #{request.nickname}, #{request.temperature},
                           #{request.humidity}, #{request.waterAmount}, #{request.wateringPeriod},
                           #{request.content}, false, #{request.feedType}, now(), now())
    </insert>

    <update id="editFeed"  parameterType="FeedRequest">
        update feed set title = #{request.title}, species = #{request.species}, nickname = #{request.nickname}, temperature = #{request.temperature},
                        humidity = #{request.humidity}, water_amount = #{request.waterAmount}, watering_period = #{request.wateringPeriod},
                        content = #{request.content}, feed_type = #{request.feedType}, modified_at = now() where feed_id = #{feedId} and user_id = #{userId}
    </update>

    <delete id="deleteAllFeeds">
        delete from feed
    </delete>

    <update id="deleteFeed" parameterType="java.lang.Long">
        update feed set is_delete = true where feed_id = #{feedId} and user_id = #{userId}
    </update>
</mapper>